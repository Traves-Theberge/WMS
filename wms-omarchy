#!/bin/bash

# WMS - Weather Management System
# Omarchy TUI Launcher Script

# Set the script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WMS_DIR="$SCRIPT_DIR"

# Check if we're in the right directory
if [[ ! -f "$WMS_DIR/go.mod" ]]; then
    echo "Error: Cannot find go.mod file. Make sure you're in the WMS project directory."
    exit 1
fi

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo "Error: Go is not installed or not in PATH."
    echo "Please install Go from https://golang.org/download/"
    exit 1
fi

# Check if .env file exists, if not copy from example
if [[ ! -f "$WMS_DIR/.env" ]]; then
    if [[ -f "$WMS_DIR/.env.example" ]]; then
        echo "Creating .env file from .env.example..."
        cp "$WMS_DIR/.env.example" "$WMS_DIR/.env"
        echo "Please edit .env file and add your WeatherAPI key before running WMS."
        echo "You can get a free API key from https://www.weatherapi.com/"
        read -p "Press Enter to continue or Ctrl+C to exit..."
    else
        echo "Warning: No .env file found. Please create one with your WeatherAPI key."
    fi
fi

# Change to the WMS directory
cd "$WMS_DIR" || exit 1

# Check if binary exists, build if needed
if [[ ! -f "$WMS_DIR/wms" ]]; then
    echo "Building WMS..."
    go build -o wms ./cmd/wms || exit 1
fi

# Run the compiled application
echo "Starting WMS..."
exec "$WMS_DIR/wms" "$@"